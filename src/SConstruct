#!/usr/bin/env python

ccflags_common = [ "-std=c89" ]
ccflags_debug = ccflags_common + [ "-g" ]
ccflags_release = ccflags_common + [ "-O2", "-DNDEBUG" ]
ccflags = ccflags_debug

buildmode = ARGUMENTS.get('mode', 'release')
if buildmode.upper() == 'DEBUG':
    ccflags = ccflags_debug
elif buildmode.upper() == 'RELEASE':
    ccflags = ccflags_release
else:
    print("Warning: Unknown mode = %s, fallback to release", buildmode)

print("Build mode = %s" % buildmode)

# Library
env = Environment(CPPPATH=[ '.' ])
env.Append(CCFLAGS=ccflags)
libesch_src = ['esch_alloc.c', 'esch_log.c', 'esch_parser.c', \
               'esch_string.c']
esch = env.StaticLibrary('esch', libesch_src)
# Unit test
utest_src = [ 'utest/esch_utest.c', \
              'utest/esch_t_alloc.c', \
              'utest/esch_t_parser.c', \
              'utest/esch_t_string.c' \
            ]
esch_utest = env.Program('esch_utest', utest_src, LIBS=[ 'esch' ], LIBPATH=[ '.' ])
# Dependencies
env.Depends(esch_utest, esch)
